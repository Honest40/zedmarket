<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZedMarket ðŸ‡¿ðŸ‡²</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --green:#198754;
  --orange:#ff8c00;
  --dark:#0f2a44;
}
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4}
header{background:var(--dark);color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:none;gap:5px;background:var(--orange);padding:8px;display:flex;}
nav button{flex:1;border:none;padding:10px;color:#fff;border-radius:6px;font-size:15px;cursor:pointer;}
nav button.active{background:var(--green)}
section{display:none;padding:15px}
input,textarea,select,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
button{background:var(--green);color:#fff;font-weight:bold;cursor:pointer}
.card{background:#fff;border-radius:10px;padding:10px;margin:10px 0;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.price{font-size:20px;color:var(--orange);font-weight:bold;margin-top:4px}
.badge{display:inline-block;background:var(--orange);color:#000;padding:3px 6px;border-radius:4px;font-size:12px;margin-left:4px}
.verified{background:var(--green);color:#fff}
img{width:100%;aspect-ratio:4/5;object-fit:cover;border-radius:8px;background:#eee}
.whatsapp{display:block;text-align:center;background:#25d366;color:#fff;padding:10px;border-radius:8px;margin-top:8px;text-decoration:none;font-weight:bold}
.refresh{background:#6c757d;margin-bottom:10px}
.searchBox{padding:6px;border:1px solid #ccc;border-radius:6px;margin-bottom:10px}
</style>
</head>

<body>

<header>ZedMarket ðŸ‡¿ðŸ‡²</header>

<section id="auth">
  <h3>Login / Register</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
</section>

<nav id="nav">
  <button data-tab="home" class="active">Home</button>
  <button data-tab="sell">Sell</button>
  <button data-tab="profile">Profile</button>
  <button id="logout">Logout</button>
</nav>

<section id="home">
  <input class="searchBox" id="searchInput" placeholder="Search listings...">
  <button class="refresh" onclick="loadListings()">ðŸ”„ Refresh</button>
  <div id="listings"></div>
</section>

<section id="sell">
  <h3>Post Listing</h3>
  <input id="title" placeholder="Title">
  <input id="price" placeholder="Price">
  <input id="image" placeholder="Image URL">
  <input id="whatsapp" placeholder="WhatsApp (260...)">
  <textarea id="desc" placeholder="Description"></textarea>
  <button id="submit">Submit</button>
  <h4>Your Pending Listings</h4>
  <div id="myListings"></div>
</section>

<section id="profile">
  <h3>Profile</h3>
  <input id="name" placeholder="Name">
  <button onclick="saveProfile()">Save</button>
</section>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
  authDomain:"pa-mwera.firebaseapp.com",
  projectId:"pa-mwera"
});

const auth=firebase.auth();
const db=firebase.firestore();

const authBox=document.getElementById("auth");
const nav=document.getElementById("nav");
const sections=document.querySelectorAll("section");

function show(id){
  sections.forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  const btn=document.querySelector(`nav button[data-tab="${id}"]`);
  if(btn)btn.classList.add("active");
}

// Login/Register
document.getElementById("loginBtn").onclick=()=> auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message));
document.getElementById("registerBtn").onclick=async()=>{
  if(!email.value || !password.value){ alert("Enter email & password"); return; }
  const c=await auth.createUserWithEmailAndPassword(email.value,password.value);
  await db.collection("users").doc(c.user.uid).set({verified:false,name:"",createdAt:Date.now()});
  alert("Registered! Now login.");
};

// Logout
document.getElementById("logout").onclick=()=>auth.signOut();

auth.onAuthStateChanged(u=>{
  if(u){
    authBox.style.display="none";
    nav.style.display="flex";
    show("home");
    loadListings();
    loadMyListings();
    loadProfile();
  }else{
    authBox.style.display="block";
    nav.style.display="none";
  }
});

document.querySelectorAll("nav button[data-tab]").forEach(b=>{b.onclick=()=>show(b.dataset.tab)});

// Load Listings (Home) with Seller Verification
async function loadListings(){
  const snap=await db.collection("listings").orderBy("createdAt","desc").get();
  const searchTerm=document.getElementById("searchInput").value.toLowerCase();
  listings.innerHTML="";
  
  for(const doc of snap.docs){
    const d = doc.data();
    if(d.status!=="approved") continue;
    if(searchTerm && !d.title.toLowerCase().includes(searchTerm) && !d.desc.toLowerCase().includes(searchTerm)) continue;

    let sellerName="Unknown Seller";
    let sellerVerified=false;

    if(d.sellerId){
      const sellerDoc = await db.collection("users").doc(d.sellerId).get();
      if(sellerDoc.exists){
        sellerName = sellerDoc.data().name || sellerName;
        sellerVerified = sellerDoc.data().verified || false;
      }
    }

    const imgUrl = d.image && d.image.trim()!=="" ? d.image : 'https://via.placeholder.com/300';

    listings.innerHTML+=`
    <div class="card">
      <img src="${imgUrl}" alt="Listing Image" onerror="this.src='https://via.placeholder.com/300'">
      <h4>${d.title} ${d.featured?'<span class="badge">SPONSORED</span>':''}</h4>
      <div class="price">${d.price}</div>
      <div>${sellerVerified?'<span class="badge verified">VERIFIED SELLER</span>':''}</div>
      <div>Seller: ${sellerName}</div>
      <p>${d.desc}</p>
      ${d.whatsapp?`<a class="whatsapp" href="https://wa.me/${d.whatsapp}" target="_blank">ðŸ’¬ WhatsApp Seller</a>`:""}
    </div>`;
  }
}

document.getElementById("searchInput").addEventListener("input", loadListings);

// Submit Listing (Sell)
document.getElementById("submit").onclick=async()=>{
  const u=auth.currentUser;
  if(!u){ alert("Login first!"); return; }
  const imgUrl = image.value.trim()!=="" ? image.value.trim() : 'https://via.placeholder.com/300';
  await db.collection("listings").add({
    title:title.value || "No title",
    price:price.value || "0",
    image:imgUrl,
    whatsapp:whatsapp.value || "",
    desc:desc.value || "",
    sellerId:u.uid,
    status:"pending",
    featured:false,
    createdAt:Date.now()
  });
  alert("Submitted for approval");
  title.value=""; price.value=""; image.value=""; whatsapp.value=""; desc.value="";
  loadMyListings();
};

// Load My Listings (Sell)
async function loadMyListings(){
  const u=auth.currentUser;
  if(!u)return;
  const snap=await db.collection("listings").where("sellerId","==",u.uid).orderBy("createdAt","desc").get();
  myListings.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    const imgUrl = d.image && d.image.trim()!=="" ? d.image : 'https://via.placeholder.com/300';
    myListings.innerHTML+=`
    <div class="card">
      <img src="${imgUrl}" alt="Listing Image" onerror="this.src='https://via.placeholder.com/300'">
      ${d.status==="pending"?"ðŸ”’ Pending":"âœ… Approved"} ${d.featured?'<span class="badge">SPONSORED</span>':''}
      <h4>${d.title}</h4>
      <div class="price">${d.price}</div>
      <button onclick="deleteListing('${doc.id}')">Delete</button>
    </div>`;
  });
}

async function deleteListing(id){
  if(confirm("Delete listing?")){await db.collection("listings").doc(id).delete(); loadMyListings();}
}

// Profile
async function loadProfile(){
  const u=auth.currentUser;
  if(!u)return;
  const doc=await db.collection("users").doc(u.uid).get();
  name.value=doc.data().name||"";
}

async function saveProfile(){
  const u=auth.currentUser;
  if(!u)return;
  await db.collection("users").doc(u.uid).update({name:name.value});
  alert("Profile updated!");
}
</script>
</body>
</html>
