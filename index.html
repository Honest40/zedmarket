<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZedMarket üáøüá≤</title>

<style>
body{font-family:Arial;margin:0;background:#f2f2f2}
header{background:#0f2a44;color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:flex;background:#198754}
nav button{flex:1;padding:10px;border:none;color:#fff;font-size:16px;cursor:pointer;position:relative}
nav button.active{background:#0f2a44}
.badge{background:red;color:#fff;border-radius:50%;font-size:12px;padding:2px 6px;position:absolute;top:4px;right:10px}
section{display:none;padding:15px}
input,select,textarea,button{width:100%;padding:10px;margin:6px 0;border-radius:5px;border:1px solid #ccc}
button{background:#198754;color:#fff}
.card{background:#fff;padding:10px;margin:10px 0;border-radius:6px;position:relative}
.card img{width:100%;height:180px;object-fit:cover;border-radius:5px}
.featured{position:absolute;top:10px;right:10px;background:#ffc107;color:#000;padding:4px 8px;border-radius:4px;font-weight:bold}
.verified{background:#0d6efd;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;display:inline-block;margin-bottom:5px}
.chatBox{background:#fff;border-radius:6px;padding:10px;height:300px;overflow:auto}
.chatMsg{margin:5px 0}
.admin{color:#0d6efd;font-weight:bold}
</style>
</head>

<body>

<header>ZedMarket üáøüá≤</header>

<section id="login">
<h3>Login / Register</h3>
<input id="email" placeholder="Email">
<input id="password" type="password">
<input id="phone" placeholder="WhatsApp 260...">
<button id="registerBtn">Register</button>
<button id="loginBtn">Login</button>
</section>

<nav id="nav" style="display:none">
<button class="active" data-tab="home">Home</button>
<button data-tab="seller">Seller</button>
<button data-tab="support">Support <span id="msgBadge" class="badge" style="display:none">!</span></button>
<button data-tab="profile">Profile</button>
<button id="logoutBtn">Logout</button>
</nav>

<section id="home">
<input id="search" placeholder="Search...">
<div id="listings"></div>
</section>

<section id="seller">
<h3>Post Listing</h3>

<select id="type">
<option value="product">Product</option>
<option value="service">Service</option>
</select>

<select id="featuredOption">
<option value="false">Normal (Free)</option>
<option value="true">‚≠ê Featured (Paid)</option>
</select>

<input id="paymentRef" placeholder="Payment Ref (if featured)">
<input id="title" placeholder="Title">
<input id="price" placeholder="Price">
<input id="imageUrl" placeholder="Image URL (optional)">
<input id="whatsapp" placeholder="WhatsApp 260...">
<textarea id="desc" placeholder="Description"></textarea>

<button id="submitBtn">Submit Listing</button>

<h3>Your Listings</h3>
<div id="myListings"></div>
</section>

<section id="support">
<h3>Support Chat</h3>
<div class="chatBox" id="chatBox"></div>
<textarea id="chatInput" placeholder="Type message..."></textarea>
<button id="sendChat">Send</button>
</section>

<section id="profile">
<input id="pName" placeholder="Name">
<input id="pPhone" placeholder="WhatsApp">
<input id="pLocation" placeholder="Location">
<button id="saveProfile">Save Profile</button>
</section>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
apiKey:"AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
authDomain:"pa-mwera.firebaseapp.com",
projectId:"pa-mwera"
});

const auth=firebase.auth();
const db=firebase.firestore();

// NAV
document.querySelectorAll("nav button[data-tab]").forEach(b=>{
b.onclick=()=>{
document.querySelectorAll("nav button").forEach(x=>x.classList.remove("active"));
b.classList.add("active");
document.querySelectorAll("section").forEach(s=>s.style.display="none");
document.getElementById(b.dataset.tab).style.display="block";
};
});

// AUTH
registerBtn.onclick=async()=>{
if(!email.value||!password.value||!phone.value)return alert("Fill all");
const c=await auth.createUserWithEmailAndPassword(email.value,password.value);
await db.collection("users").doc(c.user.uid).set({
phone:phone.value,isVerified:false
});
alert("Registered");
};
loginBtn.onclick=()=>auth.signInWithEmailAndPassword(email.value,password.value);
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(u=>{
if(u){
login.style.display="none";
nav.style.display="flex";
home.style.display="block";
loadListings();loadMy();loadChat();
}else{
login.style.display="block";
nav.style.display="none";
}
});

// SUBMIT LISTING
submitBtn.onclick=async()=>{
const u=auth.currentUser;
if(!u)return;
await db.collection("listings").add({
sellerId:u.uid,
title:title.value,
price:price.value,
image:imageUrl.value||null,
whatsapp:whatsapp.value,
description:desc.value,
type:type.value,
featured:featuredOption.value==="true",
paymentRef:paymentRef.value||null,
status:featuredOption.value==="true"?"pending_payment":"pending",
createdAt:Date.now()
});
alert("Submitted");
};

// LOAD LISTINGS (FEATURED FIRST)
async function loadListings(){
const snap=await db.collection("listings")
.where("status","==","approved")
.orderBy("featured","desc")
.orderBy("createdAt","desc")
.get();

listings.innerHTML="";
snap.forEach(doc=>{
const d=doc.data();
listings.innerHTML+=`
<div class="card">
${d.featured?'<div class="featured">FEATURED</div>':''}
<img src="${d.image||'https://via.placeholder.com/300'}">
<h4>${d.title}</h4>
<p>${d.price}</p>
<a href="https://wa.me/${d.whatsapp}" target="_blank">WhatsApp</a>
</div>`;
});
}

// MY LISTINGS (EDIT / DELETE)
async function loadMy(){
const u=auth.currentUser;
const snap=await db.collection("listings").where("sellerId","==",u.uid).get();
myListings.innerHTML="";
snap.forEach(doc=>{
myListings.innerHTML+=`
<div class="card">
${doc.data().status}
<button onclick="edit('${doc.id}')">Edit</button>
<button onclick="del('${doc.id}')">Delete</button>
</div>`;
});
}
window.del=id=>db.collection("listings").doc(id).delete();

// SUPPORT CHAT (LIVE)
function loadChat(){
const u=auth.currentUser;
db.collection("supportChats").doc(u.uid).collection("messages")
.orderBy("time")
.onSnapshot(snap=>{
chatBox.innerHTML="";
snap.forEach(doc=>{
const d=doc.data();
chatBox.innerHTML+=`
<div class="chatMsg ${d.from==='admin'?'admin':''}">
${d.from}: ${d.text}
</div>`;
if(d.from==="admin")msgBadge.style.display="inline";
});
});
}

sendChat.onclick=async()=>{
const u=auth.currentUser;
await db.collection("supportChats").doc(u.uid)
.collection("messages").add({
from:"user",
text:chatInput.value,
time:Date.now()
});
chatInput.value="";
msgBadge.style.display="none";
};

// PROFILE
saveProfile.onclick=async()=>{
await db.collection("users").doc(auth.currentUser.uid).update({
name:pName.value,phone:pPhone.value,location:pLocation.value
});
alert("Saved");
};
</script>

</body>
</html>
