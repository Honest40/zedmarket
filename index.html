<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZedMarket ðŸ‡¿ðŸ‡²</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --green:#198754;
  --orange:#ff8c00;
  --dark:#0f2a44;
}
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4}
header{background:var(--dark);color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:none;gap:5px;background:var(--orange);padding:8px;flex-wrap:wrap}
nav button{flex:1;border:none;padding:10px;color:#fff;border-radius:6px;font-size:15px;cursor:pointer;margin:2px}
nav button.active{background:var(--green)}
section{display:none;padding:15px}
input,textarea,select,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
button{background:var(--green);color:#fff;font-weight:bold;cursor:pointer}
.card{background:#fff;border-radius:10px;padding:10px;margin:10px 0;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.price{font-size:20px;color:var(--orange);font-weight:bold}
.badge{display:inline-block;background:var(--orange);color:#000;padding:3px 6px;border-radius:4px;font-size:12px;margin-left:4px}
.pendingBadge{background:#6c757d;color:#fff}
img{width:100%;aspect-ratio:4/5;object-fit:cover;border-radius:8px;background:#eee}
.whatsapp{display:block;text-align:center;background:#25d366;color:#fff;padding:10px;border-radius:8px;margin-top:8px;text-decoration:none;font-weight:bold}
.refresh{background:#6c757d}
</style>
</head>

<body>

<header>ZedMarket ðŸ‡¿ðŸ‡²</header>

<section id="authBox">
  <h3>Login / Register</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
</section>

<nav id="nav">
  <button data-tab="home" class="active">Home</button>
  <button data-tab="sell">Sell</button>
  <button data-tab="profile">Profile</button>
  <button id="logout">Logout</button>
</nav>

<section id="home">
  <input id="searchInput" placeholder="Search listings...">
  <select id="sortListings">
    <option value="newest">Newest First</option>
    <option value="priceLow">Price Low â†’ High</option>
    <option value="priceHigh">Price High â†’ Low</option>
  </select>
  <button class="refresh" onclick="loadListings()">ðŸ”„ Refresh</button>
  <div id="listings"></div>
</section>

<section id="sell">
  <h3>Post Listing</h3>
  <input id="title" placeholder="Title">
  <input id="price" placeholder="Price">
  <input type="file" id="imageFile" accept="image/*">
  <input id="whatsapp" placeholder="WhatsApp (260...)">
  <textarea id="desc" placeholder="Description"></textarea>
  <button id="submit">Submit</button>
  <h4>Your Listings</h4>
  <div id="myListings"></div>
</section>

<section id="profile">
  <h3>Profile</h3>
  <input id="name" placeholder="Name">
  <button onclick="saveProfile()">Save</button>
</section>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
  authDomain:"pa-mwera.firebaseapp.com",
  projectId:"pa-mwera"
});

const fbAuth = firebase.auth();
const db = firebase.firestore();

const authBox = document.getElementById("authBox");
const nav = document.getElementById("nav");

/* AUTH */
loginBtn.onclick=()=>fbAuth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message));
registerBtn.onclick=async()=>{
  const c=await fbAuth.createUserWithEmailAndPassword(email.value,password.value);
  await db.collection("users").doc(c.user.uid).set({name:"",verified:false});
  alert("Registered! Login now.");
};
logout.onclick=()=>fbAuth.signOut();

/* STATE */
fbAuth.onAuthStateChanged(u=>{
  if(u){
    authBox.style.display="none";
    nav.style.display="flex";
    show("home");
    loadListings();
    loadMyListings();
    loadProfile();
  }else{
    authBox.style.display="block";
    nav.style.display="none";
    show("authBox");
  }
});

/* NAV */
function show(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

/* CLOUDINARY */
async function uploadToCloudinary(file){
  const fd=new FormData();
  fd.append("file",file);
  fd.append("upload_preset","zedmarket");
  const r=await fetch("https://api.cloudinary.com/v1_1/dc5moeafv/image/upload",{method:"POST",body:fd});
  const d=await r.json();
  if(!d.secure_url) throw "Upload failed";
  return d.secure_url;
}

/* SUBMIT */
submit.onclick=async()=>{
  const u=fbAuth.currentUser;
  if(!u) return alert("Login first");
  const file=imageFile.files[0];
  if(!file) return alert("Select image");
  const imageURL=await uploadToCloudinary(file);
  await db.collection("listings").add({
    title:title.value,
    price:price.value,
    image:imageURL,
    whatsapp:whatsapp.value,
    desc:desc.value,
    sellerId:u.uid,
    status:"pending",
    createdAt:Date.now()
  });
  alert("Submitted for approval");
  imageFile.value="";title.value="";price.value="";whatsapp.value="";desc.value="";
  loadMyListings();
};

/* LOAD */
async function loadListings(){
  const snap=await db.collection("listings").get();
  listings.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    if(d.status!=="approved")return;
    listings.innerHTML+=`
    <div class="card">
      <img src="${d.image}">
      <h4>${d.title}</h4>
      <div class="price">${d.price}</div>
      <p>${d.desc}</p>
    </div>`;
  });
}

async function loadMyListings(){
  const snap=await db.collection("listings").where("sellerId","==",fbAuth.currentUser.uid).get();
  myListings.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    myListings.innerHTML+=`
    <div class="card">
      <img src="${d.image}">
      <span class="badge pendingBadge">${d.status}</span>
      <h4>${d.title}</h4>
    </div>`;
  });
}

/* PROFILE */
async function loadProfile(){
  const doc=await db.collection("users").doc(fbAuth.currentUser.uid).get();
  name.value=doc.data().name||"";
}
async function saveProfile(){
  await db.collection("users").doc(fbAuth.currentUser.uid).update({name:name.value});
  alert("Profile saved");
}
</script>
</body>
</html>
