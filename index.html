<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZedMarket ðŸ‡¿ðŸ‡² Seller</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
header{background:#ff7a00;color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:none;background:#fff;position:fixed;bottom:0;width:100%;border-top:1px solid #ccc}
nav button{flex:1;padding:12px;border:none;background:none;font-size:14px}
section{display:none;padding:15px}
.active{display:block}
.card{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
input,textarea{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
.main{background:#ff7a00;color:#fff;padding:10px;border:none;border-radius:6px;width:100%}
.price{font-size:22px;color:#ff7a00;font-weight:bold}
.badge{background:#ffc107;padding:3px 6px;border-radius:4px;font-size:12px}
.verify{background:#198754;color:#fff}
.chatBox{height:200px;overflow:auto;border:1px solid #ddd;padding:8px;border-radius:6px}
img{width:100%;max-height:320px;object-fit:contain;border-radius:6px}
.refresh{background:#0d6efd;color:#fff}
.whatsapp{background:#25D366;color:#fff}
</style>
</head>

<body>

<header>ZedMarket Seller ðŸ‡¿ðŸ‡²</header>

<!-- AUTH -->
<section id="authPage" class="active">
  <h3>Login / Register</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button class="main" id="loginBtn">Login / Register</button>
  <p id="authError" style="color:red"></p>
</section>

<!-- HOME -->
<section id="home">
  <button class="refresh" onclick="loadHome()">ðŸ”„ Refresh</button>
  <div id="homeListings"></div>
</section>

<!-- ADD -->
<section id="add">
  <h3>Add Listing</h3>
  <input id="title" placeholder="Title">
  <input id="price" placeholder="Price">
  <input id="imageUrl" placeholder="Image URL (portrait supported)">
  <label><input type="checkbox" id="sponsored"> Sponsored</label>
  <button class="main" onclick="addListing()">Post</button>
</section>

<!-- MY LISTINGS -->
<section id="mine">
  <h3>My Listings</h3>
  <div id="myListings"></div>
</section>

<!-- CHAT -->
<section id="chat">
  <h3>Support Chat</h3>
  <div class="chatBox" id="chatBox"></div>
  <input id="chatMsg" placeholder="Type message">
</section>

<!-- PROFILE -->
<section id="profile">
  <h3>Profile</h3>
  <input id="name" placeholder="Name">
  <input id="phone" placeholder="Phone">
  <button class="main" onclick="saveProfile()">Save</button>
  <button class="main verify">Verified Seller</button>
  <button class="main whatsapp" onclick="openWhatsApp()">WhatsApp</button>
  <button onclick="logout()">Logout</button>
</section>

<nav id="nav">
  <button onclick="showTab('home')">Home</button>
  <button onclick="showTab('add')">Add</button>
  <button onclick="showTab('mine')">My Ads</button>
  <button onclick="showTab('chat')">Chat</button>
  <button onclick="showTab('profile')">Profile</button>
</nav>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
 authDomain:"pa-mwera.firebaseapp.com",
 projectId:"pa-mwera"
});

const firebaseAuth=firebase.auth();
const db=firebase.firestore();

function showTab(id){
 document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

loginBtn.onclick=async()=>{
 try{
  await firebaseAuth.signInWithEmailAndPassword(email.value,password.value)
 }catch(e){
  if(e.code==="auth/user-not-found"){
   await firebaseAuth.createUserWithEmailAndPassword(email.value,password.value)
  }else authError.textContent=e.message
 }
}

firebaseAuth.onAuthStateChanged(async u=>{
 if(!u) return;
 authPage.style.display="none";
 nav.style.display="flex";
 showTab("home");
 await db.collection("users").doc(u.uid).set({name:"",phone:"",verified:true},{merge:true});
 loadHome();loadMine();loadChat();
});

function logout(){firebaseAuth.signOut();location.reload()}

async function addListing(){
 await db.collection("listings").add({
  title:title.value,
  price:price.value,
  image:imageUrl.value,
  sponsored:sponsored.checked,
  uid:firebaseAuth.currentUser.uid,
  status:"approved"
 });
 alert("Posted!");
}

function loadHome(){
 db.collection("listings").where("status","==","approved")
 .onSnapshot(s=>{
  homeListings.innerHTML="";
  s.forEach(d=>{
   const x=d.data();
   homeListings.innerHTML+=`
   <div class="card">
    <img src="${x.image}">
    <h4>${x.title} ${x.sponsored?'<span class="badge">SPONSORED</span>':''}</h4>
    <div class="price">K ${x.price}</div>
   </div>`
  })
 })
}

function loadMine(){
 db.collection("listings").where("uid","==",firebaseAuth.currentUser.uid)
 .onSnapshot(s=>{
  myListings.innerHTML="";
  s.forEach(d=>{
   const x=d.data();
   myListings.innerHTML+=`
   <div class="card">
    <img src="${x.image}">
    <h4>${x.title}</h4>
    <div class="price">K ${x.price}</div>
   </div>`
  })
 })
}

function loadChat(){
 db.collection("messages").doc(firebaseAuth.currentUser.uid)
 .collection("chat").orderBy("time")
 .onSnapshot(s=>{
  chatBox.innerHTML="";
  s.forEach(m=>{
   chatBox.innerHTML+=`<div>${m.data().text}</div>`
  })
 })
 chatMsg.onkeydown=e=>{
  if(e.key==="Enter"){
   db.collection("messages").doc(firebaseAuth.currentUser.uid)
   .collection("chat").add({text:chatMsg.value,time:Date.now(),from:"seller"})
   chatMsg.value=""
  }
 }
}

async function saveProfile(){
 await db.collection("users").doc(firebaseAuth.currentUser.uid)
 .update({name:name.value,phone:phone.value})
 alert("Saved")
}

function openWhatsApp(){
 window.open("https://wa.me/260"+phone.value.replace(/\D/g,""))
}
</script>
</body>
</html>
