<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pamwera Sale & Buy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{--green:#198754;--orange:#ff8c00;--dark:#0f2a44;}
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4}
header{background:var(--dark);color:#fff;padding:15px;text-align:center;}
header div:first-child{font-size:24px;font-weight:bold;}
header div:last-child{font-size:14px;color:#fff;opacity:0.85;}
nav{display:none;gap:5px;background:var(--orange);padding:8px;flex-wrap:wrap}
nav button{flex:1;border:none;padding:10px;color:#fff;border-radius:6px;font-size:15px;cursor:pointer;margin:2px}
nav button.active{background:var(--green)}
section{display:none;padding:15px}
input,textarea,select,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
button{background:var(--green);color:#fff;font-weight:bold;cursor:pointer}
.card{background:#fff;border-radius:10px;padding:10px;margin:10px 0;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.price{font-size:20px;color:var(--orange);font-weight:bold;margin-top:4px}
.badge{display:inline-block;background:var(--orange);color:#000;padding:3px 6px;border-radius:4px;font-size:12px;margin-left:4px}
.sponsoredBadge{background:gold;color:#000;font-weight:bold;}
.verified{background:var(--green);color:#fff}
.pendingBadge{background:#6c757d;color:#fff}
img{width:100%;height:auto;max-height:400px;object-fit:contain;border-radius:8px;background:#eee;}
.contactBtns{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;}
.contactBtns a{flex:1;text-align:center;text-decoration:none;padding:10px;border-radius:8px;color:#fff;font-weight:bold;transition:0.3s;}
.contactBtns a.whatsappBtn{background:#25d366;}
.contactBtns a.supportBtn{flex:0 0 auto;padding:5px 10px;font-size:14px;background:#25d366;}
.refresh{background:#6c757d;margin-bottom:10px}
.editBtn{background:#ffc107;color:#000;margin-top:5px;}
.reactBtns button{margin-right:5px;padding:5px 10px;border-radius:5px;border:none;cursor:pointer;}
</style>
</head>
<body>

<header>
  <div>Pamwera Sale & Buy</div>
  <div>Genuine Products / Items</div>
</header>

<section id="authBox">
  <h3>Login / Register</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
</section>

<nav id="nav">
  <button data-tab="home" class="active">Home</button>
  <button data-tab="sell">Sell</button>
  <button data-tab="profile">Profile</button>
  <button id="logout">Logout</button>
</nav>

<section id="home">
  <input id="searchInput" placeholder="Search listings...">
  <select id="sortListings">
    <option value="newest">Newest First</option>
    <option value="priceLow">Price Low ‚Üí High</option>
    <option value="priceHigh">Price High ‚Üí Low</option>
  </select>
  <button class="refresh" onclick="loadListings()">üîÑ Refresh</button>
  <div id="listings"></div>
</section>

<section id="sell">
  <h3>Post Listing</h3>
  <input id="title" placeholder="Title">
  <input id="price" placeholder="Price">
  <input type="file" id="imageFile" accept="image/*">
  <select id="location">
    <option value="">Select Location</option>
    <option value="Lusaka">Lusaka</option>
    <option value="Copperbelt">Copperbelt</option>
    <option value="Southern">Southern</option>
    <option value="Eastern">Eastern</option>
    <option value="Northern">Northern</option>
    <option value="Luapula">Luapula</option>
    <option value="Western">Western</option>
    <option value="North-Western">North-Western</option>
    <option value="Muchinga">Muchinga</option>
    <option value="Central">Central</option>
  </select>
  <input id="whatsapp" placeholder="WhatsApp (260...)">
  <textarea id="desc" placeholder="Description"></textarea>
  <button id="submit">Submit</button>
  <h4>Your Listings</h4>
  <div id="myListings"></div>
</section>

<section id="profile">
  <h3>Profile</h3>
  <input id="name" placeholder="Name">
  <button id="saveProfile">Save</button>
</section>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
  authDomain:"pa-mwera.firebaseapp.com",
  projectId:"pa-mwera"
});

const auth = firebase.auth();
const db = firebase.firestore();

const authBox = document.getElementById("authBox");
const nav = document.getElementById("nav");
const email = document.getElementById("email");
const password = document.getElementById("password");
const title = document.getElementById("title");
const price = document.getElementById("price");
const whatsapp = document.getElementById("whatsapp");
const desc = document.getElementById("desc");
const imageFile = document.getElementById("imageFile");
const locationSelect = document.getElementById("location");
const nameInput = document.getElementById("name");
const listingsDiv = document.getElementById("listings");
const myListingsDiv = document.getElementById("myListings");

/* NAVIGATION */
function show(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  const btn = document.querySelector(`nav button[data-tab="${id}"]`);
  if(btn) btn.classList.add("active");
}
document.querySelectorAll("nav button[data-tab]").forEach(b=>b.onclick=()=>show(b.dataset.tab));

/* LOGIN / REGISTER */
document.getElementById("loginBtn").onclick = () => auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message));
document.getElementById("registerBtn").onclick = async () => {
  if(!email.value || !password.value){ alert("Enter email & password"); return; }
  const c = await auth.createUserWithEmailAndPassword(email.value,password.value);
  await db.collection("users").doc(c.user.uid).set({name:"",verified:false});
  alert("Registered! Login now.");
};
document.getElementById("logout").onclick = () => auth.signOut();

auth.onAuthStateChanged(u=>{
  if(u){
    authBox.style.display="none";
    nav.style.display="flex";
    show("home");
    loadListings();
    loadMyListings();
    loadProfile();
  }else{
    authBox.style.display="block";
    nav.style.display="none";
    show("authBox");
  }
});

/* CLOUDINARY UPLOAD */
async function uploadToCloudinary(file){
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", "zedmarket");
  const r = await fetch("https://api.cloudinary.com/v1_1/dc5moeafv/image/upload", {method:"POST", body:fd});
  const d = await r.json();
  if(!d.secure_url) throw "Upload failed";
  return d.secure_url;
}

function formatZMW(value){return new Intl.NumberFormat('en-ZM', {style:'currency', currency:'ZMW'}).format(value);}

/* SUBMIT LISTING */
document.getElementById("submit").onclick = async () => {
  const u = auth.currentUser;
  if(!u) return alert("Login first");
  const file = imageFile.files[0];
  if(!file) return alert("Select image");
  const imageURL = await uploadToCloudinary(file);
  await db.collection("listings").add({
    title:title.value,
    price:price.value,
    image:imageURL,
    whatsapp:whatsapp.value,
    desc:desc.value,
    location:locationSelect.value,
    sellerId:u.uid,
    status:"pending",
    featured:false,
    reactions:[],
    createdAt:Date.now()
  });
  alert("Submitted for approval");
  imageFile.value=""; title.value=""; price.value=""; whatsapp.value=""; desc.value=""; locationSelect.value="";
  loadMyListings();
  loadListings();
};

/* LISTINGS */
async function loadListings(){
  const snap = await db.collection("listings").get();
  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
  const sortVal = document.getElementById("sortListings").value;
  const user = auth.currentUser;
  let arr = [];
  snap.forEach(doc=>{
    const d = doc.data();
    if(d.status!=="approved" && d.sellerId!==user?.uid) return;
    if(searchTerm && !d.title.toLowerCase().includes(searchTerm) && !d.desc.toLowerCase().includes(searchTerm)) return;
    arr.push({...d,id:doc.id});
  });
  arr.sort((a,b)=>{
    if(sortVal==="newest") return b.createdAt - a.createdAt;
    if(sortVal==="priceLow") return parseFloat(a.price)-parseFloat(b.price);
    if(sortVal==="priceHigh") return parseFloat(b.price)-parseFloat(a.price);
  });
  listingsDiv.innerHTML = "";
  for(const d of arr){
    let sellerName = "Unknown";
    let verified = false;
    if(d.sellerId){
      const docu = await db.collection("users").doc(d.sellerId).get();
      if(docu.exists){ sellerName = docu.data().name || sellerName; verified = docu.data().verified; }
    }
    listingsDiv.innerHTML += `
    <div class="card">
      <img src="${d.image}" onerror="this.src='https://via.placeholder.com/300'">
      <h4>${d.title} ${d.featured?'<span class="badge sponsoredBadge">‚≠ê SPONSORED</span>':''}</h4>
      <div class="price">${formatZMW(d.price)} ${d.status==="pending"?'<span class="badge pendingBadge">Pending</span>':'<span class="badge verified">Approved</span>'}</div>
      <div>Location: ${d.location || 'Not specified'}</div>
      <div>Seller: ${sellerName} ${verified?'<span class="badge verified">‚úÖ VERIFIED</span>':''}</div>
      <p>${d.desc}</p>
      <div class="contactBtns">
        ${d.whatsapp?`<a class="whatsappBtn" href="https://wa.me/${d.whatsapp}" target="_blank">üí¨ Contact Seller</a>`:""}
        <a class="supportBtn" href="https://wa.me/260776942402" target="_blank">üõ† Contact Support</a>
      </div>
      <div class="reactBtns">
        <button onclick="reactListing('${d.id}')">‚ù§Ô∏è React (${d.reactions?.length || 0})</button>
      </div>
    </div>`;
  }
}

document.getElementById("searchInput").addEventListener("input", loadListings);
document.getElementById("sortListings").addEventListener("change", loadListings);

/* REACT */
async function reactListing(listingId){
  const user = auth.currentUser;
  if(!user) return alert("Login first to react");
  const docRef = db.collection("listings").doc(listingId);
  const doc = await docRef.get();
  let reactions = doc.data().reactions || [];
  if(reactions.includes(user.uid)){
    reactions = reactions.filter(id => id!==user.uid);
  } else {
    reactions.push(user.uid);
  }
  await docRef.update({reactions});
  loadListings();
  loadMyListings();
}

/* MY LISTINGS */
async function loadMyListings(){
  const snap = await db.collection("listings").where("sellerId","==",auth.currentUser.uid).get();
  myListingsDiv.innerHTML="";
  snap.forEach(doc=>{
    const d = doc.data();
    myListingsDiv.innerHTML += `
    <div class="card">
      <img src="${d.image}" onerror="this.src='https://via.placeholder.com/300'">
      <h4>${d.title} ${d.featured?'<span class="badge sponsoredBadge">‚≠ê SPONSORED</span>':''}</h4>
      <div class="price">${formatZMW(d.price)} ${d.status==="pending"?'<span class="badge pendingBadge">Pending</span>':'<span class="badge verified">Approved</span>'}</div>
      <div>Location: ${d.location || 'Not specified'}</div>
      <div>Seller: You <span class="badge verified">‚úÖ</span></div>
      <p>${d.desc}</p>
      <div class="contactBtns">
        ${d.whatsapp?`<a class="whatsappBtn" href="https://wa.me/${d.whatsapp}" target="_blank">üí¨ Contact Seller</a>`:""}
        <a class="supportBtn" href="https://wa.me/260776942402" target="_blank">üõ† Contact Support</a>
      </div>
      <div class="reactBtns">
        <button onclick="reactListing('${doc.id}')">‚ù§Ô∏è React (${d.reactions?.length || 0})</button>
      </div>
    </div>`;
  });
}

/* PROFILE */
async function loadProfile(){
  const doc = await db.collection("users").doc(auth.currentUser.uid).get();
  nameInput.value = doc.data().name || "";
}
document.getElementById("saveProfile").onclick = async () => {
  const u = auth.currentUser;
  if(!u) return alert("Login first");
  const newName = nameInput.value.trim();
  if(!newName){ alert("Enter a name"); return; }
  await db.collection("users").doc(u.uid).update({name: newName});
  alert("Profile name saved!");
  loadProfile();
};
</script>
</body>
</html>

