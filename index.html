<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZedMarket ðŸ‡¿ðŸ‡²</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f6f6f6}
header{background:#ff7a00;color:#fff;padding:14px;text-align:center;font-size:20px}
nav{display:flex;justify-content:space-around;background:#fff;padding:10px;border-bottom:1px solid #ddd}
nav button{background:none;border:none;font-size:15px;cursor:pointer}
section{display:none;padding:15px}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
img.listing{width:100%;max-height:360px;object-fit:contain;border-radius:6px;background:#fafafa}
.price{font-size:22px;color:#ff7a00;font-weight:bold}
.badge{display:inline-block;padding:3px 7px;font-size:12px;border-radius:4px;margin-left:5px}
.verified{background:#198754;color:#fff}
.sponsored{background:#ffc107;color:#000}
button.primary{background:#ff7a00;color:#fff;border:none;padding:10px;border-radius:6px;width:100%;margin-top:8px}
input,textarea{width:100%;padding:9px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
.whatsapp{background:#25D366;color:#fff;text-decoration:none;padding:10px;display:block;text-align:center;border-radius:6px;margin-top:8px}
.chatBox{height:200px;overflow:auto;background:#fafafa;border:1px solid #ccc;padding:8px;border-radius:6px}
.hidden{display:none}
</style>
</head>

<body>

<header>ZedMarket ðŸ‡¿ðŸ‡²</header>

<!-- LOGIN -->
<section id="login">
  <h3>Login</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button class="primary" id="loginBtn">Login</button>
  <p id="authError" style="color:red"></p>
</section>

<!-- APP -->
<div id="app" class="hidden">

<nav>
  <button onclick="show('home')">Home</button>
  <button onclick="show('sell')">Sell</button>
  <button onclick="show('profile')">Profile</button>
  <button onclick="show('support')">Support</button>
  <button onclick="refresh()">ðŸ”„</button>
</nav>

<section id="home"></section>

<section id="sell">
  <h3>Post Listing</h3>
  <input id="title" placeholder="Title">
  <input id="price" placeholder="Price">
  <input id="image" placeholder="Image URL (portrait works best)">
  <input id="whatsapp" placeholder="WhatsApp number (260...)">
  <button class="primary" onclick="submitListing()">Submit</button>
</section>

<section id="profile">
  <h3>Profile</h3>
  <input id="name" placeholder="Name">
  <button class="primary" onclick="saveProfile()">Save</button>
  <button class="primary" onclick="logout()">Logout</button>
</section>

<section id="support">
  <h3>Support Chat</h3>
  <div class="chatBox" id="chatBox"></div>
  <input id="msg" placeholder="Type message...">
  <button class="primary" onclick="sendMsg()">Send</button>
</section>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
  authDomain: "pa-mwera.firebaseapp.com",
  projectId: "pa-mwera",
  storageBucket: "pa-mwera.firebasestorage.app",
  messagingSenderId: "959795010421",
  appId: "1:959795010421:web:84e1cc1517a5d98598113c"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const loginBox=document.getElementById("login");
const app=document.getElementById("app");
const home=document.getElementById("home");
let currentUser=null;

/* LOGIN */
loginBtn.onclick=async()=>{
  try{
    await auth.signInWithEmailAndPassword(email.value,password.value);
  }catch(e){
    authError.textContent=e.message;
  }
};

auth.onAuthStateChanged(async user=>{
  if(!user) return;
  currentUser=user;
  loginBox.style.display="none";
  app.classList.remove("hidden");
  await ensureProfile();
  loadListings();
  loadChat();
  show('home');
});

/* PROFILE */
async function ensureProfile(){
  const ref=db.collection("users").doc(currentUser.uid);
  const doc=await ref.get();
  if(!doc.exists){
    await ref.set({
      name:"",
      verified:false,
      createdAt:Date.now()
    });
  }
}

async function saveProfile(){
  await db.collection("users").doc(currentUser.uid).update({
    name:name.value
  });
  alert("Saved");
}

/* NAV */
function show(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}
function refresh(){ location.reload(); }

/* LISTINGS */
function loadListings(){
  db.collection("listings")
    .where("status","==","approved")
    .onSnapshot(async snap=>{
      home.innerHTML="";
      for(const doc of snap.docs){
        const d=doc.data();
        const seller=await db.collection("users").doc(d.uid).get();
        const s=seller.data();
        home.innerHTML+=`
        <div class="card">
          <img class="listing" src="${d.image}">
          <h4>${d.title}</h4>
          <div class="price">ZMW ${d.price}</div>
          <div>
            ${s?.verified?'<span class="badge verified">Verified</span>':''}
            ${d.sponsored?'<span class="badge sponsored">Sponsored</span>':''}
          </div>
          <a class="whatsapp" href="https://wa.me/${d.whatsapp}" target="_blank">WhatsApp Seller</a>
        </div>`;
      }
    });
}

/* SELL */
async function submitListing(){
  await db.collection("listings").add({
    title:title.value,
    price:price.value,
    image:image.value,
    whatsapp:whatsapp.value,
    uid:currentUser.uid,
    status:"pending",
    sponsored:false,
    createdAt:Date.now()
  });
  alert("Submitted for approval");
}

/* SUPPORT CHAT */
function loadChat(){
  db.collection("messages")
    .doc(currentUser.uid)
    .collection("chat")
    .orderBy("time")
    .onSnapshot(snap=>{
      chatBox.innerHTML="";
      snap.forEach(m=>{
        chatBox.innerHTML+=`<div>${m.data().text}</div>`;
      });
      chatBox.scrollTop=chatBox.scrollHeight;
    });
}
function sendMsg(){
  if(!msg.value) return;
  db.collection("messages")
    .doc(currentUser.uid)
    .collection("chat")
    .add({text:msg.value,from:"user",time:Date.now()});
  msg.value="";
}

/* LOGOUT */
function logout(){
  auth.signOut();
  location.reload();
}
</script>

</body>
</html>
