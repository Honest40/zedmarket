<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pamwera Sale & Buy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{--green:#198754;--orange:#ff8c00;--dark:#0f2a44;}
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4}
header{background:var(--dark);color:#fff;padding:15px;text-align:center}
header .title{font-size:26px;font-weight:bold}
header .subtitle{font-size:14px;opacity:.9}

nav{display:none;background:var(--orange);padding:8px;gap:5px;flex-wrap:wrap}
nav button{flex:1;border:none;padding:10px;color:#fff;border-radius:6px;font-weight:bold;cursor:pointer}
nav button.active{background:var(--green)}

section{display:none;padding:15px}
input,textarea,select,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
button{background:var(--green);color:#fff;font-weight:bold;cursor:pointer}

.card{background:#fff;border-radius:10px;padding:10px;margin:10px 0;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.price{font-size:20px;color:var(--orange);font-weight:bold}

.badge{padding:3px 6px;border-radius:4px;font-size:12px;margin-left:4px}
.verified{background:#198754;color:#fff}
.pending{background:#6c757d;color:#fff}
.sponsored{background:gold;color:#000;font-weight:bold}

img{width:100%;max-height:400px;object-fit:contain;background:#eee;border-radius:8px}

.contactBtns{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.contactBtns a{text-decoration:none;color:#fff;padding:10px;border-radius:8px;font-weight:bold;text-align:center}
.whatsapp{background:#25d366}
.support{background:#128c7e;font-size:14px;padding:6px 10px}

.reactBtns button{background:#dc3545;border:none;border-radius:6px;padding:6px 12px}
.refresh{background:#6c757d;margin-bottom:10px}
</style>
</head>

<body>

<header>
  <div class="title">Pamwera Sale & Buy</div>
  <div class="subtitle">Genuine Products / Items</div>
</header>

<section id="authBox">
  <h3>Login / Register</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
</section>

<nav id="nav">
  <button data-tab="home" class="active">Home</button>
  <button data-tab="sell">Sell</button>
  <button data-tab="profile">Profile</button>
  <button id="logout">Logout</button>
</nav>

<section id="home">
  <input id="searchInput" placeholder="Search listings">
  <select id="sortListings">
    <option value="newest">Newest</option>
    <option value="priceLow">Price Low ‚Üí High</option>
    <option value="priceHigh">Price High ‚Üí Low</option>
  </select>
  <button class="refresh" onclick="loadListings()">üîÑ Refresh</button>
  <div id="listings"></div>
</section>

<section id="sell">
  <h3>Post Listing</h3>

  <!-- IMAGE COMES FROM APP -->
  <button onclick="alert('Use the app Choose Image button')">Choose Image (App)</button>

  <input id="title" placeholder="Title">
  <input id="price" placeholder="Price">
  <select id="location">
    <option value="">Select Location</option>
    <option>Lusaka</option><option>Copperbelt</option><option>Central</option>
    <option>Southern</option><option>Eastern</option><option>Northern</option>
    <option>Luapula</option><option>Western</option><option>Muchinga</option>
    <option>North-Western</option>
  </select>
  <input id="whatsapp" placeholder="WhatsApp (260...)">
  <textarea id="desc" placeholder="Description"></textarea>
  <button id="submit">Submit</button>
  <div id="myListings"></div>
</section>

<section id="profile">
  <h3>Profile</h3>
  <input id="name" placeholder="Your name">
  <button id="saveProfile">Save</button>
</section>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
  authDomain:"pa-mwera.firebaseapp.com",
  projectId:"pa-mwera"
});

const auth=firebase.auth(), db=firebase.firestore();
let selectedAppImage=null;

/* CALLED BY NIO TRON */
function receiveImageFromApp(url){
  selectedAppImage=url;
  alert("Image selected successfully");
}

function show(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.querySelector(`[data-tab="${id}"]`)?.classList.add("active");
}
document.querySelectorAll("nav button[data-tab]").forEach(b=>b.onclick=()=>show(b.dataset.tab));

auth.onAuthStateChanged(u=>{
  if(u){
    authBox.style.display="none";
    nav.style.display="flex";
    show("home");
    loadListings(); loadMyListings(); loadProfile();
  }else{
    authBox.style.display="block";
    nav.style.display="none";
    show("authBox");
  }
});

loginBtn.onclick=()=>auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message));
registerBtn.onclick=async()=>{
  const c=await auth.createUserWithEmailAndPassword(email.value,password.value);
  await db.collection("users").doc(c.user.uid).set({name:"",verified:false});
  alert("Registered");
};
logout.onclick=()=>auth.signOut();

function ZMW(v){return new Intl.NumberFormat('en-ZM',{style:'currency',currency:'ZMW'}).format(v);}

submit.onclick=async()=>{
  if(!selectedAppImage) return alert("Choose image first");
  const u=auth.currentUser;
  await db.collection("listings").add({
    title:title.value,
    price:price.value,
    image:selectedAppImage,
    whatsapp:whatsapp.value,
    desc:desc.value,
    location:location.value,
    sellerId:u.uid,
    status:"pending",
    reactions:[],
    createdAt:Date.now()
  });
  alert("Submitted for approval");
  selectedAppImage=null;
  loadListings(); loadMyListings();
};

async function loadListings(){
  const snap=await db.collection("listings").get();
  listings.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    if(d.status!=="approved") return;
    listings.innerHTML+=`
    <div class="card">
      <img src="${d.image}">
      <h4>${d.title}</h4>
      <div class="price">${ZMW(d.price)}</div>
      <div>üìç ${d.location}</div>
      <p>${d.desc}</p>
      <div class="contactBtns">
        <a class="whatsapp" href="https://wa.me/${d.whatsapp}" target="_blank">Contact Seller</a>
        <a class="support" href="https://wa.me/260776942402" target="_blank">Support</a>
      </div>
      <div class="reactBtns">
        <button onclick="react('${doc.id}')">‚ù§Ô∏è ${d.reactions.length}</button>
      </div>
    </div>`;
  });
}

async function react(id){
  const ref=db.collection("listings").doc(id);
  const d=(await ref.get()).data();
  let r=d.reactions;
  const u=auth.currentUser.uid;
  r=r.includes(u)?r.filter(x=>x!==u):[...r,u];
  await ref.update({reactions:r});
  loadListings();
}

async function loadMyListings(){
  const snap=await db.collection("listings").where("sellerId","==",auth.currentUser.uid).get();
  myListings.innerHTML="<h4>Your Listings</h4>";
  snap.forEach(d=>{
    myListings.innerHTML+=`<div class="card">${d.data().title}</div>`;
  });
}

async function loadProfile(){
  const d=await db.collection("users").doc(auth.currentUser.uid).get();
  name.value=d.data().name||"";
}
saveProfile.onclick=()=>db.collection("users").doc(auth.currentUser.uid).update({name:name.value}).then(()=>alert("Saved"));
</script>
</body>
</html>
