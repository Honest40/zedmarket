<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZedMarket ðŸ‡¿ðŸ‡²</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --green:#198754;
  --orange:#ff8c00;
  --dark:#0f2a44;
}
body{margin:0;font-family:Arial;background:#f4f4f4}
header{background:var(--dark);color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:none;gap:5px;background:var(--orange);padding:8px}
nav button{flex:1;border:none;padding:10px;color:#fff;border-radius:6px;font-size:15px}
nav button.active{background:var(--green)}
section{display:none;padding:15px}
input,textarea,select,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
button{background:var(--green);color:#fff;font-weight:bold;cursor:pointer}
.card{background:#fff;border-radius:10px;padding:10px;margin:10px 0;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.price{font-size:20px;color:var(--orange);font-weight:bold;margin-top:4px}
.badge{display:inline-block;background:var(--orange);color:#000;padding:3px 6px;border-radius:4px;font-size:12px;margin-left:4px}
.verified{background:var(--green);color:#fff}
img{width:100%;aspect-ratio:4/5;object-fit:cover;border-radius:8px}
.whatsapp{display:block;text-align:center;background:#25d366;color:#fff;padding:10px;border-radius:8px;margin-top:8px;text-decoration:none;font-weight:bold}
.refresh{background:#6c757d;margin-bottom:10px}
</style>
</head>

<body>

<header>ZedMarket ðŸ‡¿ðŸ‡²</header>

<section id="auth">
  <h3>Login / Register</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
</section>

<nav id="nav">
  <button data-tab="home" class="active">Home</button>
  <button data-tab="sell">Sell</button>
  <button data-tab="profile">Profile</button>
  <button id="logout">Logout</button>
</nav>

<section id="home">
  <button class="refresh" onclick="loadListings()">ðŸ”„ Refresh</button>
  <div id="listings"></div>
</section>

<section id="sell">
  <h3>Post Listing</h3>
  <input id="title" placeholder="Title">
  <input id="price" placeholder="Price">
  <input id="image" placeholder="Image URL">
  <input id="whatsapp" placeholder="WhatsApp (260...)">
  <textarea id="desc" placeholder="Description"></textarea>
  <button id="submit">Submit</button>
  <h4>Your Pending Listings</h4>
  <div id="myListings"></div>
</section>

<section id="profile">
  <h3>Profile</h3>
  <input id="name" placeholder="Name">
  <button onclick="saveProfile()">Save</button>
</section>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
  authDomain:"pa-mwera.firebaseapp.com",
  projectId:"pa-mwera"
});

const auth=firebase.auth();
const db=firebase.firestore();

const authBox=document.getElementById("auth");
const nav=document.getElementById("nav");
const sections=document.querySelectorAll("section");

function show(id){
  sections.forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  const btn=document.querySelector(`nav button[data-tab="${id}"]`);
  if(btn)btn.classList.add("active");
}

// Login/Register
document.getElementById("loginBtn").onclick=()=>{
  auth.signInWithEmailAndPassword(email.value,password.value)
  .catch(e=>alert(e.message));
};

document.getElementById("registerBtn").onclick=async()=>{
  const c=await auth.createUserWithEmailAndPassword(email.value,password.value);
  await db.collection("users").doc(c.user.uid).set({verified:false,name:"",createdAt:Date.now()});
  alert("Registered! Now login.");
};

// Logout
document.getElementById("logout").onclick=()=>auth.signOut();

auth.onAuthStateChanged(u=>{
  if(u){
    authBox.style.display="none";
    nav.style.display="flex";
    show("home");
    loadListings();
    loadMyListings();
    loadProfile();
  }else{
    authBox.style.display="block";
    nav.style.display="none";
  }
});

document.querySelectorAll("nav button[data-tab]").forEach(b=>{
  b.onclick=()=>show(b.dataset.tab);
});

// Load Listings (Home)
async function loadListings(){
  const snap=await db.collection("listings").where("status","==","approved").get();
  listings.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    listings.innerHTML+=`
    <div class="card">
      <img src="${d.image}">
      <h4>${d.title} ${d.featured?'<span class="badge">SPONSORED</span>':''}</h4>
      <div class="price">${d.price}</div>
      <div>${d.sellerVerified?'<span class="badge verified">VERIFIED SELLER</span>':''}</div>
      <p>${d.desc}</p>
      <a class="whatsapp" href="https://wa.me/${d.whatsapp}" target="_blank">ðŸ’¬ WhatsApp Seller</a>
    </div>`;
  });
}

// Submit Listing (Sell)
document.getElementById("submit").onclick=async()=>{
  const u=auth.currentUser;
  if(!u)return;
  const userDoc=await db.collection("users").doc(u.uid).get();
  await db.collection("listings").add({
    title:title.value,
    price:price.value,
    image:image.value,
    whatsapp:whatsapp.value,
    desc:desc.value,
    status:"pending",
    featured:false,
    sellerVerified:userDoc.data().verified||false,
    createdAt:Date.now()
  });
  alert("Submitted for approval");
  title.value=""; price.value=""; image.value=""; whatsapp.value=""; desc.value="";
  loadMyListings();
};

// Load My Pending Listings (Sell)
async function loadMyListings(){
  const u=auth.currentUser;
  if(!u)return;
  const snap=await db.collection("listings").where("sellerId","==",u.uid).get();
  myListings.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    myListings.innerHTML+=`
    <div class="card">
      ${d.status==="pending"?"ðŸ”’ Pending":"âœ… Approved"} ${d.featured?'<span class="badge">SPONSORED</span>':''}
      <h4>${d.title}</h4>
      <div class="price">${d.price}</div>
      <button onclick="deleteListing('${doc.id}')">Delete</button>
    </div>`;
  });
}

async function deleteListing(id){
  if(confirm("Delete listing?")){await db.collection("listings").doc(id).delete(); loadMyListings();}
}

// Profile
async function loadProfile(){
  const u=auth.currentUser;
  if(!u)return;
  const doc=await db.collection("users").doc(u.uid).get();
  name.value=doc.data().name||"";
}

async function saveProfile(){
  const u=auth.currentUser;
  if(!u)return;
  await db.collection("users").doc(u.uid).update({name:name.value});
  alert("Profile updated!");
}
</script>

</body>
</html>
