<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZedMarket üáøüá≤</title>

<style>
body{font-family:Arial;margin:0;background:#f2f2f2}
header{background:#0f2a44;color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:flex;background:#198754}
nav button{flex:1;padding:10px;border:none;color:#fff;font-size:16px;cursor:pointer}
nav button.active{background:#0f2a44}
section{display:none;padding:15px}
input,select,textarea,button{width:100%;padding:10px;margin:6px 0;border-radius:5px;border:1px solid #ccc}
button{background:#198754;color:#fff}
.card{background:#fff;padding:10px;margin:10px 0;border-radius:6px;position:relative}
.card img{width:100%;height:180px;object-fit:cover;border-radius:5px}
.featured{position:absolute;top:10px;right:10px;background:#ffc107;color:#000;padding:4px 8px;border-radius:4px;font-weight:bold}
.verified{background:#0d6efd;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;display:inline-block;margin-bottom:5px}
.seller{font-size:13px;color:#555;margin-bottom:5px}
</style>
</head>

<body>

<header>ZedMarket üáøüá≤</header>

<section id="login">
<h3>Login / Register</h3>
<input id="email" placeholder="Email">
<input id="password" type="password">
<input id="phone" placeholder="WhatsApp 260...">
<button id="registerBtn">Register</button>
<button id="loginBtn">Login</button>
</section>

<nav id="nav" style="display:none">
<button class="active" data-tab="home">Home</button>
<button data-tab="seller">Seller</button>
<button data-tab="profile">Profile</button>
<button id="logoutBtn">Logout</button>
</nav>

<section id="home">
<input id="search" placeholder="Search listings...">
<div id="listings"></div>
</section>

<section id="seller">
<h3>Post Listing</h3>

<select id="type">
<option value="product">Product</option>
<option value="service">Service</option>
</select>

<select id="featuredOption">
<option value="false">Normal (Free)</option>
<option value="true">‚≠ê Featured (Paid)</option>
</select>

<input id="paymentRef" placeholder="Payment reference (if featured)">
<input id="title" placeholder="Title">
<input id="price" placeholder="Price">
<input id="imageUrl" placeholder="Image URL (optional)">
<input type="file" id="imageFile" accept="image/*">
<input id="whatsapp" placeholder="WhatsApp 260...">
<textarea id="desc" placeholder="Description"></textarea>

<button id="submitBtn">Submit Listing</button>

<h3>Your Listings</h3>
<div id="myListings"></div>
</section>

<section id="profile">
<input id="pName" placeholder="Name">
<input id="pPhone" placeholder="WhatsApp">
<input id="pLocation" placeholder="Location">
<button id="saveProfile">Save Profile</button>
</section>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<script>
firebase.initializeApp({
apiKey:"AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
authDomain:"pa-mwera.firebaseapp.com",
projectId:"pa-mwera",
storageBucket:"pa-mwera.firebasestorage.app"
});

const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

/* NAV */
document.querySelectorAll("nav button[data-tab]").forEach(b=>{
b.onclick=()=>{
document.querySelectorAll("nav button").forEach(x=>x.classList.remove("active"));
b.classList.add("active");
document.querySelectorAll("section").forEach(s=>s.style.display="none");
document.getElementById(b.dataset.tab).style.display="block";
};
});

/* AUTH */
registerBtn.onclick=async()=>{
if(!email.value||!password.value||!phone.value)return alert("Fill all fields");
const c=await auth.createUserWithEmailAndPassword(email.value,password.value);
await db.collection("users").doc(c.user.uid).set({
phone:phone.value,name:"Seller",isVerified:false
});
alert("Registered");
};

loginBtn.onclick=()=>auth.signInWithEmailAndPassword(email.value,password.value);
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(u=>{
if(u){
login.style.display="none";
nav.style.display="flex";
home.style.display="block";
loadListings(); loadMy(); loadProfile();
}else{
login.style.display="block";
nav.style.display="none";
}
});

/* SUBMIT LISTING (UPLOAD FIXED) */
submitBtn.onclick=async()=>{
const u=auth.currentUser;
if(!u)return alert("Login first");

let imageFinal=imageUrl.value.trim();

if(imageFile.files.length){
const ref=storage.ref("listings/"+u.uid+"_"+Date.now());
await ref.put(imageFile.files[0]);
imageFinal=await ref.getDownloadURL();
}

await db.collection("listings").add({
sellerId:u.uid,
title:title.value,
price:price.value,
image:imageFinal||null,
whatsapp:whatsapp.value,
description:desc.value,
type:type.value,
featured:featuredOption.value==="true",
paymentRef:paymentRef.value||null,
status:featuredOption.value==="true"?"pending_payment":"pending",
createdAt:Date.now()
});

alert("Listing submitted");
};

/* LOAD APPROVED LISTINGS (NO INDEX BUG) */
async function loadListings(){
const snap=await db.collection("listings").get();
listings.innerHTML="";

let approved=snap.docs
.map(d=>({id:d.id,...d.data()}))
.filter(l=>l.status==="approved")
.sort((a,b)=>b.featured-a.featured || b.createdAt-a.createdAt);

for(const l of approved){
const sellerDoc=await db.collection("users").doc(l.sellerId).get();
const seller=sellerDoc.exists?sellerDoc.data():{};
const verified=seller.isVerified;

listings.innerHTML+=`
<div class="card">
${verified?'<div class="verified">‚úî VERIFIED SELLER</div>':''}
${l.featured?'<div class="featured">FEATURED</div>':''}
<div class="seller">Seller: ${seller.name||"Seller"}</div>
<img src="${l.image||'https://via.placeholder.com/300'}">
<h4>${l.title}</h4>
<p>${l.price}</p>
<a href="https://wa.me/${l.whatsapp}" target="_blank">WhatsApp</a>
</div>`;
}
}

/* MY LISTINGS */
async function loadMy(){
const u=auth.currentUser;
const snap=await db.collection("listings").where("sellerId","==",u.uid).get();
myListings.innerHTML="";
snap.forEach(doc=>{
const d=doc.data();
myListings.innerHTML+=`
<div class="card">
${d.status}
<button onclick="db.collection('listings').doc('${doc.id}').delete()">Delete</button>
</div>`;
});
}

/* PROFILE */
async function loadProfile(){
const d=await db.collection("users").doc(auth.currentUser.uid).get();
if(d.exists){
pName.value=d.data().name||"";
pPhone.value=d.data().phone||"";
pLocation.value=d.data().location||"";
}
}
saveProfile.onclick=async()=>{
await db.collection("users").doc(auth.currentUser.uid).update({
name:pName.value,phone:pPhone.value,location:pLocation.value
});
alert("Profile saved");
};
</script>

</body>
</html>
